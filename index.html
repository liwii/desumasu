<!DOCTYPE html>
<!-- saved from url=(0234)https://itc-lms.ecc.u-tokyo.ac.jp/lms/course/report/submission_download/index.html?reportId=65820&idnumber=202105100710B01&downloadFileName=index.html&objectName=2021%2Ffd%2Fd8%2F1a%2Ffdd81a5d-b22b-4d18-a8f2-31687e2bee59&downloadMode= -->
<html lang="ja"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script type='text/javascript' src='http://code.jquery.com/jquery-1.7.2.min.js'></script>
<title>ですます変換</title>
</head>
<body data-new-gr-c-s-check-loaded="14.1018.0" data-gr-ext-installed="" cz-shortcut-listen="true">

<script>
document.oncontextmenu = function() { return false; }
function goodPosition(top, left) {
    var rightEnd = $("#output")[0].getBoundingClientRect().right;
    if(left + 300 > rightEnd) {
        left = rightEnd - 300;
    }
    return {top: top, left: left};
}
var lastSelectionRange;
document.onselectionchange = () => {
    var selection = document.getSelection();
    var selectionRange = selection.getRangeAt(0);
    if(selectionRange.collapsed) {
        return;
    }
    var intersectionWithSpn = false;
    document.querySelectorAll('.spn').forEach(element => {
        if(selectionRange.intersectsNode(element)) intersectionWithSpn = true;

    });
    if(intersectionWithSpn) {
        $("#edit-text-modal").hide();
        return;
    }
    var selectionText = selection.toString();
    $("#edit-span-modal").hide();
    var selectionPosition = selection.getRangeAt(0).getBoundingClientRect();
    var modalPosition =  goodPosition(selectionPosition.bottom, (selectionPosition.right + selectionPosition.left) / 2)
    $("#edit-text-modal").show();
    $("#original-text").val(selectionText);
    $("#new-text").val("");
    $("#edit-text-modal").css(modalPosition);
    lastSelectionRange = selection.getRangeAt(0);

};
outputHistory = []
var rules = {
	"します": "する",
	"ました": "た",
}

function undo() {
    if(outputHistory.length == 0) return;
    var lastHtml = outputHistory.pop();
    $("#output").html(lastHtml);
    if(outputHistory.length == 0) {
        $("#undoButton").prop('disabled', true);
    }
}

function showModal(id) {
    $("#edit-text-modal").hide();
    $("#edit-span-modal").toggle();
    if($("#edit-span-modal").is(":visible")) {
        $("#original-span").val($("#" + id).attr("original"));
        $("#new-span").val("");
        var textPosition = $("#" + id).offset();
        textPosition = goodPosition(textPosition.top + 10, textPosition.left + 10);
        textPosition.top += 10;
        textPosition.left += 10;
        $("#edit-span-modal").css(textPosition);
        $("#edit-span-modal").attr("span-id", id);
    }
}

function backToOriginal() {
    outputHistory.push($("#output").html());
    let spanId = $("#edit-span-modal").attr("span-id");
    $("#" + spanId).replaceWith($("#" + spanId).attr("original"));
    $("#edit-span-modal").hide();
    $("#undoButton").prop('disabled', false);
}

function updateHere() {
    outputHistory.push($("#output").html());
    let spanId = $("#edit-span-modal").attr("span-id");
    $("#" + spanId).html("<font color=\"red\">"+$("#new-span").val()+"</font>");
    $("#edit-span-modal").hide();
    $("#undoButton").prop('disabled', false);
}

function highlight(line, index, original){
	return ("<span class=\"spn\" id=\"span"+index+"\" oncontextmenu=\"swap("+index+")\" onclick=\"showModal(this.id)\" original= " + original + "><font color=\"red\">"+line+"</font></span>");
}

function convert(){
	var source = document.getElementById("source").value;
	var output = "";
	var index = 0;

	for(i=0; i<source.length; i++){
		var rest = source.slice(i, source.length);
		var rule_keys = Object.keys(rules);
        var key_applied = false;
		for(let key of rule_keys) {
			if(rest.startsWith(key)) {
				output += highlight(rules[key], index, key);
                index++;
                i+=key.length - 1;
                key_applied = true;
                break;
			}
		}
        if(!key_applied) {
            output+=source.slice(i, i+1);
        }
	}

	document.getElementById('output').innerHTML = output;
}
</script>

<form><textarea id="source" rows="10" cols="100">原文</textarea><br></form>
<button onclick="convert()">変換</button>
<button id="undoButton" onclick="undo()" disabled>一つ戻る</button>
<div id="output">変換後の文章</div>
<div id="edit-span-modal" style="position: absolute; left: 0px; top: 0px; width: 300px; height: 100px; background: rgb(168, 168, 168); display: none; z-index: 1000; margin:10px;">
    <div><span>元のテキスト　　</span><input type="text" id="original-span" disabled></div>
    <div><span>変換後のテキスト</span><input type="text" id="new-span"></div>
    <button onclick="backToOriginal()">元に戻す</button>
    <button onclick="updateHereSpan()">ここだけ変換</button>
</div>

<div id="edit-text-modal" style="position: absolute; left: 0px; top: 0px; width: 300px; height: 100px; background: rgb(168, 168, 168); display: none; z-index: 1000; margin:10px;">
    <div><span>元のテキスト　　</span><input type="text" id="original-text" disabled></div>
    <div><span>変換後のテキスト</span><input type="text" id="new-text"></div>
</div>



</body></html>